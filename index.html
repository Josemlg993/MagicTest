<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Test interactivo</title>
  <link rel="stylesheet" href="main.css">
  <!-- Añade los estilos de la columna lateral y pregunta-grupo a tu main.css -->
  <style>
    /* Solo para el mensaje de respuesta correcta */
    .respuesta-correcta {
      margin-top: 10px;
      color: #2ecc71;
      font-weight: bold;
      font-size: 1.05em;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h2>Prueba tipo test</h2>
    <div class="cuestionario-lista" id="cuestionarioLista"></div>
    <div class="marcadores-lateral" id="marcadoresLateral"></div>
    <div id="test"></div>
    <div id="result" class="result"></div>
  </div>
  <script>
    // Lista de cuestionarios
    const cuestionariosLocales = [
      { archivo: "https://josemlg993.github.io/MagicTest/Cuestionarios/Tema1.json", titulo: "Tema 1 (online)" },
      { archivo: "Tema2.json", titulo: "Tema 2 (local)" }
    ];

    const respuestasFijas = [
      "todas las anteriores",
      "todas las opciones anteriores",
      "A y B son correctas",
      "A, B y C son correctas"
    ];

    let questions = [];
    let userAnswers = {};
    let results = {};

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function shuffleAnswers(answers) {
      let fixedIndexes = [];
      let fixedAnswers = [];
      answers.forEach((ans, idx) => {
        for (let frase of respuestasFijas) {
          if (ans.toLowerCase().includes(frase)) {
            fixedIndexes.push(idx);
            fixedAnswers.push(ans);
          }
        }
      });
      if (fixedIndexes.length > 0) {
        let movibles = answers.filter((_, idx) => !fixedIndexes.includes(idx));
        shuffle(movibles);
        let resultado = [];
        let m = 0, f = 0;
        for (let i = 0; i < answers.length; i++) {
          if (fixedIndexes.includes(i)) {
            resultado.push(fixedAnswers[f++]);
          } else {
            resultado.push(movibles[m++]);
          }
        }
        return resultado;
      } else {
        let copia = answers.slice();
        shuffle(copia);
        return copia;
      }
    }

    function listarCuestionariosLocales() {
      const listaDiv = document.getElementById('cuestionarioLista');
      if (cuestionariosLocales.length === 0) {
        listaDiv.innerHTML = "<p>No hay cuestionarios locales disponibles.</p>";
        return;
      }
      listaDiv.innerHTML = "<b>Elige un cuestionario:</b>";
      cuestionariosLocales.forEach(function(item) {
        const btn = document.createElement('button');
        btn.textContent = item.titulo;
        btn.onclick = function() {
          cargarCuestionarioLocal(item.archivo, item.titulo);
        };
        listaDiv.appendChild(btn);
      });
    }

    function cargarCuestionarioLocal(archivo, titulo) {
      document.getElementById('test').innerHTML = `<p>Cargando cuestionario <b>${titulo}</b>...</p>`;
      document.getElementById('result').textContent = "";
      fetch(archivo.includes('http') ? archivo : 'cuestionarios/' + archivo)
        .then(response => response.json())
        .then(data => {
          let preguntasBarajadas = data.slice();
          shuffle(preguntasBarajadas);
          questions = preguntasBarajadas.map(q => {
            const originalAnswers = q.answers.slice();
            const correctText = originalAnswers[0];
            const shuffled = shuffleAnswers(originalAnswers);
            return {
              question: q.question,
              answers: shuffled,
              correctText: correctText
            };
          });
          userAnswers = {};
          results = {};
          mostrarTodasLasPreguntas();
        })
        .catch(err => {
          document.getElementById('test').innerHTML = "Error al cargar el cuestionario.";
          console.error(err);
        });
    }

    function mostrarTodasLasPreguntas() {
      let html = '';
      questions.forEach((q, idx) => {
        let clase = results[idx] === "correct" ? "pregunta-grupo correct" : results[idx] === "incorrect" ? "pregunta-grupo incorrect" : "pregunta-grupo";
        html += `<div class="${clase}" id="pregunta-${idx}">
          <div class="question">${idx + 1}. ${q.question}</div>
          <ul class="answers">`;
        q.answers.forEach((ans, i) => {
          let checked = userAnswers[idx] === ans ? 'checked' : '';
          let disabled = results[idx] ? 'disabled' : '';
          html += `<li>
            <label>
              <input type="radio" name="q${idx}" value="${ans.replace(/"/g, '&quot;')}" ${checked} ${disabled}
                onchange="responderPregunta(${idx}, this.value)">
              ${ans}
            </label>
          </li>`;
        });
        html += `</ul>`;
        // Si falló, muestra la respuesta correcta debajo
        if (results[idx] === "incorrect") {
          html += `<div class="respuesta-correcta">Respuesta correcta: ${q.correctText}</div>`;
        }
        html += `</div>`;
      });
      document.getElementById('test').innerHTML = html;
      actualizarMarcadorGlobal();
      renderMarcadoresLateral();
    }

    // Renderiza la columna lateral de marcadores
    function renderMarcadoresLateral(selectedIdx = -1) {
      const cont = document.getElementById('marcadoresLateral');
      let html = `<b>Preguntas</b><br>`;
      questions.forEach((q, idx) => {
        let estado = "unanswered";
        if (results[idx] === "correct") estado = "correct";
        else if (results[idx] === "incorrect") estado = "incorrect";
        let icono = estado === "correct" ? "✅" : estado === "incorrect" ? "❌" : "❓";
        let selected = (selectedIdx === idx) ? "selected" : "";
        html += `<div class="marcador-item ${estado} ${selected}" onclick="scrollToPregunta(${idx})">
          <span class="marcador-num">Pregunta ${idx + 1}</span>
          <span class="marcador-ico ${estado}">${icono}</span>
        </div>`;
      });
      cont.innerHTML = html;
    }

    // Scroll suave a la pregunta correspondiente
    window.scrollToPregunta = function(idx) {
      const el = document.getElementById('pregunta-' + idx);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        renderMarcadoresLateral(idx);
        setTimeout(() => renderMarcadoresLateral(), 1300);
      }
    };

    // Esta función se llama al marcar una respuesta
    window.responderPregunta = function(idx, value) {
      userAnswers[idx] = value;
      let correcta = questions[idx].correctText;
      if (value === correcta) {
        results[idx] = "correct";
      } else {
        results[idx] = "incorrect";
      }
      mostrarTodasLasPreguntas();
    };

    function actualizarMarcadorGlobal() {
      let total = questions.length;
      let correctas = Object.values(results).filter(r => r === "correct").length;
      let incorrectas = Object.values(results).filter(r => r === "incorrect").length;
      let sinResponder = total - correctas - incorrectas;
      document.getElementById('result').innerHTML = `
        <b>✅ Correctas:</b> ${correctas} &nbsp; 
        <b>❌ Incorrectas:</b> ${incorrectas} &nbsp; 
        <b>❓ Sin responder:</b> ${sinResponder}
      `;
    }

    // Inicializar
    listarCuestionariosLocales();
  </script>
</body>
</html>
